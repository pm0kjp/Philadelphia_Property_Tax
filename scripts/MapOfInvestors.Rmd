---
title: "Philadelphia Property Tax Delinquency: Investor Impact"
author: "Joy Payton"
date: "11/30/2016"
output: html_document
---

```{r echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, message = FALSE)
```

## Load Libraries

```{r}
library(dplyr)
library(stringr)
library(jsonlite)
```

## Obtain the data

We use get the cleaned, Census-tract enriched data from the R object I created 
in my TaxDataSetup script.  Let's check it out:
```{r}
taxDataCleaned <- completeRows
str(taxDataCleaned)
summary(taxDataCleaned)
```

## Clean Data

Remove rows that won't help us because they list no owner:

```{r}
taxDataCleaned <- taxDataCleaned %>% filter(Owner != "")
```

Clean out the $ found in the money fields and convert to numeric

```{r}
taxDataCleaned$Total <- as.numeric(gsub('\\$','',taxDataCleaned$Total))
taxDataCleaned$Market.Value <- as.numeric(gsub('\\$','',taxDataCleaned$Market.Value))
```

## What is the impact of investors?

As a secondary exploration into our data, we'll want to see what the impact of
investors is (we saw some interesting trends of large investors in our ["Worst
100 Tax Delinquents" visualization](http://codepen.io/kjoypayton/full/JbyyJx/)).

Let's count only the
properties that have overdue tax and do some summarizing by owner.  

We consider a "deadbeat investor" to be someone with three or more 
overdue properties.

```{r}
lastSixteenData <- taxDataCleaned %>% filter(Tax.Period < 2016, Tax.Period >= 2000)

investors <- lastSixteenData %>% 
                    filter(Total > 0) %>% 
                    group_by(Owner, Tax.Period) %>% 
                    summarise(TotalOwed = sum(Total), 
                              NumOverdueProperties = n()) %>%
                    arrange(desc(NumOverdueProperties)) %>% 
                    filter(NumOverdueProperties >=3)

```

We have thousands of potential investors... but we know that some are actually 
governmental agencies.  Let's remove those as we discover them:

```{r}
investors <- investors %>% filter(Owner != "PHILA HOUSING AUTHORITY")
investors <- investors %>% filter(Owner != "CITY OF PHILADELPHIA")
investors <- investors %>% filter(Owner != "ADMIN OF VET AFFAIRS")
investors <- investors %>% filter(Owner != "OFFICE OF THE DISTRICT AT")
investors <- investors %>% filter(Owner != "ADMIN OF VETS AFFAIRS")
investors <- investors %>% filter(Owner != "CITY OF PHILA")
investors <- investors %>% filter(Owner != "ADMIN OF VETERAN AFFAIRS")
investors <- investors %>% filter(Owner != "ADM OF VET AFFAIRS")
```

What's the impact of deadbeat investors in 2000?  In 2015?

```{r}
sum(investors$TotalOwed[investors$Tax.Period == 2000])
sum(investors$NumOverdueProperties[investors$Tax.Period == 2000])
sum(investors$TotalOwed[investors$Tax.Period == 2015])
sum(investors$NumOverdueProperties[investors$Tax.Period == 2015])
```

In 2000, we had almost $400k due on 731 properties, and in 2015, we see
$5.6 million due on 6500 properties... a huge increase!  We want to 
concentrate on these owners who are unlikely (due to the number of properties)
to be simple homeowners down on their luck.  Let's dig a bit deeper.  

We wonder where these investor-owned deadbeat properties are distributed across 
the city. Our data doesn't include zip code, but it does have geocoded 
coordinates.  We can do something with that!

Let's look at Census tracts.  These are helpful because they are small enough to
give us some neighborhood-by-neighborhood comparison of how many investor-
owned properties are in delinquency.  Because the Census Bureau also collects a
number of demographic data on the tract level, we can also look to see if there
are any patterns.  Do deadbeat investors take on properties in economically 
strapped neighborhoods? 

First, let's get all of our investment properties, and set up our latitude and 
longitude fields. Once again, let's only worry about 2015.

```{r}
investmentProperties <- lastSixteenData %>% 
                        filter(Total >0) %>% 
  filter (Owner %in% investors$Owner) %>%
                        group_by(Tax.Period)
                        
```

That's all of our "deadbeat" investment properties: the properties which have
had a balance owed in the last 16 years and have an owner who, in at least one
of the last sixteen years has had 3 or more overdue properties.  Let's take that
data and aggregate by Census tract, to give us more information on the 
year-by-year impact of deadbeat investors in each tract.

```{r}
tractOverdueTax <- investmentProperties %>%
  group_by(Census.Tract, Tax.Period) %>%
  summarise(totalOwedByTract = sum(Total))
```
 
Let's save this as a .csv!

```{r}
write.csv(tractOverdueTax, "tractOverdueTax.csv", row.names = FALSE)
```

We can use this data to come up with a cool map in D3!

